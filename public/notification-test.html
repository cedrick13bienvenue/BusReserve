<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bus Booking - Notification Testing Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: white;
        padding: 20px 30px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .connection-status {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
      }

      .status-connected {
        background: #10b981;
        color: white;
      }

      .status-disconnected {
        background: #ef4444;
        color: white;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f3f4f6;
      }

      .test-section {
        margin-bottom: 30px;
      }

      .test-section h3 {
        color: #667eea;
        margin-bottom: 15px;
        font-size: 18px;
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group label {
        display: block;
        margin-bottom: 5px;
        color: #666;
        font-weight: 500;
        font-size: 14px;
      }

      .input-group input,
      .input-group select {
        width: 100%;
        padding: 10px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .input-group input:focus,
      .input-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
        width: 100%;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-warning {
        background: #f59e0b;
        color: white;
      }

      .btn-danger {
        background: #ef4444;
        color: white;
      }

      .btn-info {
        background: #3b82f6;
        color: white;
      }

      .notifications-panel {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
      }

      .notification-item {
        background: #f9fafb;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 12px;
        border-radius: 6px;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .notification-item.priority-urgent {
        border-left-color: #ef4444;
        background: #fef2f2;
      }

      .notification-item.priority-high {
        border-left-color: #f59e0b;
        background: #fffbeb;
      }

      .notification-item.priority-medium {
        border-left-color: #3b82f6;
        background: #eff6ff;
      }

      .notification-item.priority-low {
        border-left-color: #10b981;
        background: #f0fdf4;
      }

      .notification-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .notification-title {
        font-weight: 600;
        color: #333;
        font-size: 15px;
      }

      .notification-time {
        font-size: 12px;
        color: #9ca3af;
      }

      .notification-message {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
      }

      .notification-type {
        display: inline-block;
        margin-top: 8px;
        padding: 4px 10px;
        background: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        color: #667eea;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-box {
        background: #f9fafb;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #667eea;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }

      .clear-btn {
        padding: 8px 16px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
      }

      .clear-btn:hover {
        background: #dc2626;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #9ca3af;
      }

      .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 15px;
        opacity: 0.5;
      }

      @media (max-width: 1024px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üöå Bus Booking - Notification Testing Dashboard</h1>
        <div>
          <span
            id="connectionStatus"
            class="connection-status status-disconnected"
          >
            ‚ö†Ô∏è Disconnected
          </span>
          <span style="margin-left: 15px; color: #666; font-size: 14px">
            User ID: <strong id="currentUserId">1</strong>
          </span>
        </div>
      </div>

      <div class="main-grid">
        <!-- Test Actions Panel -->
        <div class="card">
          <h2>üß™ Test Actions</h2>

          <div class="stats">
            <div class="stat-box">
              <div class="stat-value" id="totalNotifications">0</div>
              <div class="stat-label">Total Notifications</div>
            </div>
            <div class="stat-box">
              <div class="stat-value" id="unreadCount">0</div>
              <div class="stat-label">Unread</div>
            </div>
          </div>

          <!-- User Selection -->
          <div class="test-section">
            <h3>üë§ User Selection</h3>
            <div class="input-group">
              <label>User ID (to receive notifications)</label>
              <input type="number" id="userId" value="1" min="1" />
            </div>
            <button class="btn btn-primary" onclick="reconnectWithUserId()">
              üîÑ Reconnect as User
            </button>
          </div>

          <!-- Booking Notifications -->
          <div class="test-section">
            <h3>üìù Booking Notifications</h3>
            <div class="input-group">
              <label>Booking Code</label>
              <input
                type="text"
                id="bookingCode"
                value="BK2024110112345ABC123456"
              />
            </div>
            <div class="input-group">
              <label>Route</label>
              <input type="text" id="route" value="Kigali ‚Üí Huye" />
            </div>
            <div class="input-group">
              <label>Seat Number</label>
              <input type="number" id="seatNumber" value="15" />
            </div>
            <button class="btn btn-success" onclick="testBookingConfirmation()">
              ‚úÖ Test Booking Confirmation
            </button>
            <button
              class="btn btn-danger"
              onclick="testBookingCancellation()"
              style="margin-top: 10px"
            >
              ‚ùå Test Booking Cancellation
            </button>
          </div>

          <!-- Seat Notifications -->
          <div class="test-section">
            <h3>ü™ë Seat Availability</h3>
            <div class="input-group">
              <label>Schedule ID</label>
              <input type="number" id="scheduleId" value="1" />
            </div>
            <div class="input-group">
              <label>Available Seats</label>
              <input type="number" id="availableSeats" value="5" min="0" />
            </div>
            <div class="input-group">
              <label>Total Seats</label>
              <input type="number" id="totalSeats" value="45" />
            </div>
            <button class="btn btn-warning" onclick="testSeatUpdate()">
              üìä Test Seat Update
            </button>
            <button
              class="btn btn-danger"
              onclick="testLowSeatWarning()"
              style="margin-top: 10px"
            >
              üö® Test Low Seat Warning
            </button>
          </div>

          <!-- System Notifications -->
          <div class="test-section">
            <h3>üì¢ System Notifications</h3>
            <div class="input-group">
              <label>Announcement Title</label>
              <input
                type="text"
                id="announcementTitle"
                value="New Feature Available!"
              />
            </div>
            <div class="input-group">
              <label>Message</label>
              <input
                type="text"
                id="announcementMessage"
                value="Check out our new mobile app for easier booking!"
              />
            </div>
            <button class="btn btn-info" onclick="testSystemAnnouncement()">
              üì£ Broadcast Announcement
            </button>
          </div>

          <!-- Room Subscription -->
          <div class="test-section">
            <h3>üîî Room Subscriptions</h3>
            <div class="input-group">
              <label>Room Type</label>
              <select id="roomType">
                <option value="schedule">Schedule</option>
                <option value="route">Route</option>
              </select>
            </div>
            <div class="input-group">
              <label>Room ID</label>
              <input type="number" id="roomId" value="1" />
            </div>
            <button class="btn btn-primary" onclick="joinRoom()">
              ‚ûï Join Room
            </button>
            <button
              class="btn btn-danger"
              onclick="leaveRoom()"
              style="margin-top: 10px"
            >
              ‚ûñ Leave Room
            </button>
          </div>
        </div>

        <!-- Notifications Panel -->
        <div class="card">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            "
          >
            <h2 style="margin: 0">üì¨ Live Notifications</h2>
            <button class="clear-btn" onclick="clearNotifications()">
              Clear All
            </button>
          </div>
          <div class="notifications-panel" id="notificationsContainer">
            <div class="empty-state">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                />
              </svg>
              <p>No notifications yet</p>
              <p style="font-size: 12px; margin-top: 5px">
                Test some actions to see notifications appear here
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let socket;
      let notifications = [];
      let currentUserId = 1;

      // Initialize Socket.IO connection
      function initializeSocket() {
        const userId = document.getElementById("userId").value || 1;
        currentUserId = parseInt(userId);

        socket = io("http://localhost:3000", {
          auth: {
            userId: currentUserId,
          },
          transports: ["websocket", "polling"],
        });

        socket.on("connect", () => {
          console.log("‚úÖ Connected to server");
          updateConnectionStatus(true);
          document.getElementById("currentUserId").textContent = currentUserId;
        });

        socket.on("disconnect", () => {
          console.log("‚ùå Disconnected from server");
          updateConnectionStatus(false);
        });

        socket.on("notification", (notification) => {
          console.log("üì¨ Notification received:", notification);
          addNotification(notification);
        });

        socket.on("booking:confirmed", (data) => {
          console.log("‚úÖ Booking confirmed:", data);
          addNotification({
            type: "booking:created",
            priority: "high",
            title: "üéâ Booking Confirmed!",
            message: `Booking ${data.bookingCode} has been confirmed.`,
            data: data,
          });
        });

        socket.on("seat:availability", (data) => {
          console.log("ü™ë Seat availability update:", data);
        });

        socket.on("seat:low", (data) => {
          console.log("‚ö†Ô∏è Low seat warning:", data);
        });

        socket.on("schedule:updated", (data) => {
          console.log("üìÖ Schedule updated:", data);
        });

        socket.on("route:updated", (data) => {
          console.log("üó∫Ô∏è Route updated:", data);
        });

        socket.on("error", (error) => {
          console.error("‚ùå Socket error:", error);
        });
      }

      function updateConnectionStatus(connected) {
        const statusEl = document.getElementById("connectionStatus");
        if (connected) {
          statusEl.className = "connection-status status-connected";
          statusEl.textContent = "‚úÖ Connected";
        } else {
          statusEl.className = "connection-status status-disconnected";
          statusEl.textContent = "‚ö†Ô∏è Disconnected";
        }
      }

      function addNotification(notification) {
        notifications.unshift(notification);
        updateNotificationsUI();
        updateStats();
      }

      function updateNotificationsUI() {
        const container = document.getElementById("notificationsContainer");

        if (notifications.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <p>No notifications yet</p>
                        <p style="font-size: 12px; margin-top: 5px;">Test some actions to see notifications appear here</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = notifications
          .map((notif) => {
            const time = notif.createdAt
              ? new Date(notif.createdAt).toLocaleTimeString()
              : new Date().toLocaleTimeString();
            return `
                    <div class="notification-item priority-${
                      notif.priority || "medium"
                    }">
                        <div class="notification-header">
                            <span class="notification-title">${
                              notif.icon || "üì¨"
                            } ${notif.title}</span>
                            <span class="notification-time">${time}</span>
                        </div>
                        <div class="notification-message">${notif.message}</div>
                        <span class="notification-type">${notif.type}</span>
                    </div>
                `;
          })
          .join("");
      }

      function updateStats() {
        document.getElementById("totalNotifications").textContent =
          notifications.length;
        const unread = notifications.filter((n) => !n.read).length;
        document.getElementById("unreadCount").textContent = unread;
      }

      function clearNotifications() {
        notifications = [];
        updateNotificationsUI();
        updateStats();
      }

      // Test Functions
      function reconnectWithUserId() {
        if (socket) {
          socket.disconnect();
        }
        initializeSocket();
      }

      function testBookingConfirmation() {
        const bookingCode = document.getElementById("bookingCode").value;
        const route = document.getElementById("route").value;
        const seatNumber = parseInt(
          document.getElementById("seatNumber").value
        );

        const notification = {
          id: "notif_" + Date.now(),
          type: "booking:created",
          priority: "high",
          title: "üéâ Booking Confirmed!",
          message: `Your booking ${bookingCode} has been confirmed. Seat ${seatNumber} for ${route}.`,
          data: { bookingCode, route, seatNumber, price: 5000 },
          actionUrl: `/bookings/${bookingCode}`,
          actionText: "View Booking",
          icon: "‚úÖ",
          read: false,
          createdAt: new Date().toISOString(),
        };

        addNotification(notification);
      }

      function testBookingCancellation() {
        const bookingCode = document.getElementById("bookingCode").value;

        const notification = {
          id: "notif_" + Date.now(),
          type: "booking:cancelled",
          priority: "medium",
          title: "‚ùå Booking Cancelled",
          message: `Your booking ${bookingCode} has been cancelled. Refund will be processed within 5-7 business days.`,
          data: { bookingCode },
          icon: "üîÑ",
          read: false,
          createdAt: new Date().toISOString(),
        };

        addNotification(notification);
      }

      function testSeatUpdate() {
        const scheduleId = document.getElementById("scheduleId").value;
        const availableSeats = parseInt(
          document.getElementById("availableSeats").value
        );
        const totalSeats = parseInt(
          document.getElementById("totalSeats").value
        );

        let priority = "low";
        let title = "ü™ë Seats Updated";
        let icon = "‚ÑπÔ∏è";

        if (availableSeats <= 5) {
          priority = "urgent";
          title = "üî• Critical: Very Few Seats!";
          icon = "‚ö†Ô∏è";
        } else if (availableSeats <= 10) {
          priority = "high";
          title = "‚ö†Ô∏è Limited Seats Available";
          icon = "‚è∞";
        }

        const notification = {
          id: "notif_" + Date.now(),
          type: "seat:updated",
          priority: priority,
          title: title,
          message: `${availableSeats} of ${totalSeats} seats available for this journey.`,
          data: { scheduleId, availableSeats, totalSeats },
          icon: icon,
          read: false,
          createdAt: new Date().toISOString(),
        };

        addNotification(notification);
      }

      function testLowSeatWarning() {
        const scheduleId = document.getElementById("scheduleId").value;
        const route = document.getElementById("route").value;
        const remainingSeats = 3;

        const notification = {
          id: "notif_" + Date.now(),
          type: "seat:low",
          priority: "urgent",
          title: "‚ö†Ô∏è Hurry! Limited Seats",
          message: `Only ${remainingSeats} seats left for ${route}. Book now!`,
          data: { scheduleId, remainingSeats, route },
          actionUrl: `/schedules/${scheduleId}`,
          actionText: "Book Now",
          icon: "üö®",
          read: false,
          createdAt: new Date().toISOString(),
        };

        addNotification(notification);
      }

      function testSystemAnnouncement() {
        const title = document.getElementById("announcementTitle").value;
        const message = document.getElementById("announcementMessage").value;

        const notification = {
          id: "notif_" + Date.now(),
          type: "system:announcement",
          priority: "medium",
          title: "üì¢ " + title,
          message: message,
          icon: "üì£",
          read: false,
          createdAt: new Date().toISOString(),
        };

        addNotification(notification);
      }

      function joinRoom() {
        const roomType = document.getElementById("roomType").value;
        const roomId = document.getElementById("roomId").value;
        const room = `${roomType}:${roomId}`;

        if (socket) {
          socket.emit("join:room", room);
          console.log(`‚úÖ Joined room: ${room}`);

          addNotification({
            id: "notif_" + Date.now(),
            type: "system:update",
            priority: "low",
            title: "‚úÖ Joined Room",
            message: `You are now subscribed to ${room} updates`,
            icon: "üîî",
            read: false,
            createdAt: new Date().toISOString(),
          });
        }
      }

      function leaveRoom() {
        const roomType = document.getElementById("roomType").value;
        const roomId = document.getElementById("roomId").value;
        const room = `${roomType}:${roomId}`;

        if (socket) {
          socket.emit("leave:room", room);
          console.log(`‚ùå Left room: ${room}`);

          addNotification({
            id: "notif_" + Date.now(),
            type: "system:update",
            priority: "low",
            title: "‚ùå Left Room",
            message: `You unsubscribed from ${room} updates`,
            icon: "üîï",
            read: false,
            createdAt: new Date().toISOString(),
          });
        }
      }

      // Initialize on page load
      window.addEventListener("DOMContentLoaded", () => {
        initializeSocket();
        updateStats();
      });
    </script>
  </body>
</html>
