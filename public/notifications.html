<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bus Booking - Real-Time Notifications</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .login-container {
        max-width: 450px;
        margin: 100px auto;
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .login-container h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 600;
      }

      .form-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 15px;
        transition: border-color 0.3s;
      }

      .form-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
      }

      .error-message {
        background: #fee;
        color: #c00;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 14px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .info-box {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
        padding: 15px;
        margin-top: 20px;
        border-radius: 6px;
        font-size: 13px;
        color: #1e40af;
      }

      .dashboard {
        display: none;
      }

      .dashboard.active {
        display: block;
      }

      .header {
        background: white;
        padding: 20px 30px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left h1 {
        color: #333;
        margin-bottom: 5px;
      }

      .user-info {
        font-size: 14px;
        color: #666;
      }

      .user-info strong {
        color: #667eea;
      }

      .header-right {
        text-align: right;
      }

      .connection-status {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 10px;
      }

      .status-connected {
        background: #10b981;
        color: white;
      }

      .status-disconnected {
        background: #ef4444;
        color: white;
      }

      .btn-logout {
        padding: 8px 20px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
      }

      .btn-logout:hover {
        background: #dc2626;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 20px;
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f3f4f6;
      }

      .stats {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        color: white;
      }

      .stat-value {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 13px;
        opacity: 0.9;
      }

      .debug-section {
        background: #f9fafb;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        font-size: 12px;
      }

      .debug-section h3 {
        color: #667eea;
        margin-bottom: 10px;
        font-size: 14px;
      }

      .debug-log {
        background: #1f2937;
        color: #10b981;
        padding: 10px;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 11px;
      }

      .debug-log div {
        margin-bottom: 5px;
      }

      .notifications-panel {
        max-height: calc(100vh - 300px);
        overflow-y: auto;
      }

      .notification-item {
        background: #f9fafb;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 12px;
        border-radius: 6px;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .notification-item.priority-urgent {
        border-left-color: #ef4444;
        background: #fef2f2;
      }

      .notification-item.priority-high {
        border-left-color: #f59e0b;
        background: #fffbeb;
      }

      .notification-item.priority-medium {
        border-left-color: #3b82f6;
        background: #eff6ff;
      }

      .notification-item.priority-low {
        border-left-color: #10b981;
        background: #f0fdf4;
      }

      .notification-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .notification-title {
        font-weight: 600;
        color: #333;
        font-size: 15px;
      }

      .notification-time {
        font-size: 12px;
        color: #9ca3af;
      }

      .notification-message {
        color: #666;
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 8px;
      }

      .notification-type {
        display: inline-block;
        padding: 4px 10px;
        background: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        color: #667eea;
      }

      .clear-btn {
        padding: 8px 16px;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
      }

      .clear-btn:hover {
        background: #dc2626;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #9ca3af;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 1024px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Login Screen -->
      <div id="loginScreen" class="login-container">
        <h1>üöå Bus Booking System</h1>
        <h2
          style="
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 18px;
          "
        >
          Real-Time Notifications
        </h2>

        <div id="errorMessage" class="error-message"></div>

        <form id="loginForm">
          <div class="form-group">
            <label>Email</label>
            <input
              type="email"
              id="email"
              required
              placeholder="Enter your email"
              value="passenger@example.com"
            />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="password"
              required
              placeholder="Enter your password"
              value="password123"
            />
          </div>
          <button type="submit" class="btn btn-primary" id="loginBtn">
            Login & Connect
          </button>
        </form>

        <div class="info-box">
          <strong>üí° How it works:</strong><br />
          1. Login with your credentials<br />
          2. Keep this page open<br />
          3. Make API calls in Postman (bookings, updates, etc.)<br />
          4. Watch real-time notifications appear here!
        </div>
      </div>

      <!-- Dashboard -->
      <div id="dashboard" class="dashboard">
        <div class="header">
          <div class="header-left">
            <h1>üöå Bus Booking Notifications</h1>
            <div class="user-info">
              Logged in as: <strong id="userName"></strong> (ID:
              <strong id="userId"></strong>)
            </div>
          </div>
          <div class="header-right">
            <div
              id="connectionStatus"
              class="connection-status status-disconnected"
            >
              ‚ö†Ô∏è Disconnected
            </div>
            <br />
            <button class="btn-logout" onclick="logout()">Logout</button>
          </div>
        </div>

        <div class="main-grid">
          <!-- Sidebar -->
          <div>
            <div class="card">
              <h2>üìä Statistics</h2>
              <div class="stats">
                <div class="stat-box">
                  <div class="stat-value" id="totalNotifications">0</div>
                  <div class="stat-label">Total Notifications</div>
                </div>
                <div
                  class="stat-box"
                  style="
                    background: linear-gradient(
                      135deg,
                      #f59e0b 0%,
                      #ef4444 100%
                    );
                  "
                >
                  <div class="stat-value" id="unreadCount">0</div>
                  <div class="stat-label">Unread</div>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top: 20px">
              <h2>üîß Debug Console</h2>
              <div class="debug-section">
                <h3>Connection Logs</h3>
                <div class="debug-log" id="debugLog">
                  <div>Waiting for connection...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Notifications Panel -->
          <div class="card">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
              "
            >
              <h2 style="margin: 0">üì¨ Live Notifications</h2>
              <button class="clear-btn" onclick="clearNotifications()">
                Clear All
              </button>
            </div>
            <div class="notifications-panel" id="notificationsContainer">
              <div class="empty-state">
                <p
                  style="font-size: 18px; font-weight: 600; margin-bottom: 10px"
                >
                  Waiting for notifications...
                </p>
                <p style="font-size: 14px">
                  Make a booking in Postman to see it appear here instantly!
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3000/api";
      const SOCKET_URL = "http://localhost:3000";
      let socket;
      let notifications = [];
      let userData = null;
      let debugLogs = [];

      function addDebugLog(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const color =
          type === "error"
            ? "#ef4444"
            : type === "success"
            ? "#10b981"
            : "#3b82f6";
        debugLogs.unshift(
          `<div style="color: ${color}">[${timestamp}] ${message}</div>`
        );
        if (debugLogs.length > 50) debugLogs.pop();

        const debugEl = document.getElementById("debugLog");
        if (debugEl) {
          debugEl.innerHTML = debugLogs.join("");
        }
      }

      // Login Form Handler
      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const loginBtn = document.getElementById("loginBtn");
          const email = document.getElementById("email").value;
          const password = document.getElementById("password").value;

          loginBtn.disabled = true;
          loginBtn.innerHTML = '<span class="loading"></span> Logging in...';
          hideError();

          try {
            addDebugLog("Attempting login...");

            const response = await fetch(`${API_URL}/auth/login`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ email, password }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || "Login failed");
            }

            addDebugLog("Login successful!", "success");

            // Store user data and token
            userData = data.user;
            localStorage.setItem("token", data.token);
            localStorage.setItem("userData", JSON.stringify(userData));

            addDebugLog(
              `User: ${userData.full_name} (ID: ${userData.id})`,
              "success"
            );

            // Show dashboard and connect to socket
            showDashboard();
            initializeSocket();
          } catch (error) {
            addDebugLog(`Login error: ${error.message}`, "error");
            showError(error.message);
            loginBtn.disabled = false;
            loginBtn.textContent = "Login & Connect";
          }
        });

      function showError(message) {
        const errorEl = document.getElementById("errorMessage");
        errorEl.textContent = message;
        errorEl.classList.add("show");
      }

      function hideError() {
        const errorEl = document.getElementById("errorMessage");
        errorEl.classList.remove("show");
      }

      function showDashboard() {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("dashboard").classList.add("active");
        document.getElementById("userName").textContent = userData.full_name;
        document.getElementById("userId").textContent = userData.id;
      }

      function initializeSocket() {
        const token = localStorage.getItem("token");

        addDebugLog("Connecting to Socket.IO server...");
        addDebugLog(`Token: ${token.substring(0, 20)}...`);

        socket = io(SOCKET_URL, {
          auth: {
            token: token,
            userId: userData.id,
          },
          transports: ["websocket", "polling"],
        });

        socket.on("connect", () => {
          addDebugLog("‚úÖ Connected to Socket.IO!", "success");
          addDebugLog(`Socket ID: ${socket.id}`, "success");
          updateConnectionStatus(true);
        });

        socket.on("disconnect", (reason) => {
          addDebugLog(`‚ùå Disconnected: ${reason}`, "error");
          updateConnectionStatus(false);
        });

        socket.on("connect_error", (error) => {
          addDebugLog(`Connection error: ${error.message}`, "error");
          updateConnectionStatus(false);
        });

        // Listen for ALL possible events
        socket.on("notification", (data) => {
          addDebugLog("üì¨ Notification received!", "success");
          console.log("Notification:", data);
          addNotification({
            ...data,
            type: data.type || "general",
            priority: data.priority || "medium",
            title: data.title || "Notification",
            message: data.message || JSON.stringify(data),
          });
        });

        socket.on("booking:created", (data) => {
          addDebugLog("‚úÖ Booking created event!", "success");
          console.log("Booking created:", data);
          addNotification({
            type: "booking:created",
            priority: "high",
            title: "üéâ Booking Confirmed!",
            message: data.message || "Your booking has been confirmed.",
            data: data,
            icon: "‚úÖ",
            createdAt: new Date().toISOString(),
          });
        });

        socket.on("booking:cancelled", (data) => {
          addDebugLog("‚ùå Booking cancelled event!", "success");
          console.log("Booking cancelled:", data);
          addNotification({
            type: "booking:cancelled",
            priority: "medium",
            title: "‚ùå Booking Cancelled",
            message: data.message || "Your booking has been cancelled.",
            data: data,
            icon: "üîÑ",
            createdAt: new Date().toISOString(),
          });
        });

        socket.on("seats:updated", (data) => {
          addDebugLog("ü™ë Seats updated event!", "success");
          console.log("Seats updated:", data);
          addNotification({
            type: "seat:updated",
            priority: "low",
            title: "ü™ë Seat Availability Updated",
            message: data.message || "Seat availability has changed.",
            data: data,
            createdAt: new Date().toISOString(),
          });
        });

        socket.on("seats:availability", (data) => {
          addDebugLog("üìä Seat availability update!", "success");
          console.log("Seat availability:", data);
        });

        socket.on("seats:low", (data) => {
          addDebugLog("‚ö†Ô∏è Low seat warning!", "success");
          console.log("Low seat warning:", data);
          addNotification({
            type: "seat:low",
            priority: "urgent",
            title: "üö® Low Seat Warning",
            message:
              data.message || `Only ${data.remainingSeats} seats remaining!`,
            data: data,
            icon: "‚ö†Ô∏è",
            createdAt: new Date().toISOString(),
          });
        });

        socket.on("schedule:updated", (data) => {
          addDebugLog("üìÖ Schedule updated!", "success");
          console.log("Schedule updated:", data);
          addNotification({
            type: "schedule:updated",
            priority: "medium",
            title: "üìÖ Schedule Updated",
            message: data.message || "A schedule has been updated",
            data: data,
            createdAt: new Date().toISOString(),
          });
        });

        socket.on("route:updated", (data) => {
          addDebugLog("üó∫Ô∏è Route updated!", "success");
          console.log("Route updated:", data);
          addNotification({
            type: "route:updated",
            priority: "medium",
            title: "üó∫Ô∏è Route Updated",
            message: data.message || "A route has been updated",
            data: data,
            createdAt: new Date().toISOString(),
          });
        });

        socket.on("system:notification", (data) => {
          addDebugLog("üì¢ System notification!", "success");
          console.log("System notification:", data);
          addNotification({
            ...data,
            type: "system:notification",
            priority: "medium",
          });
        });

        socket.on("error", (error) => {
          addDebugLog(`Socket error: ${error}`, "error");
          console.error("Socket error:", error);
        });

        // Log all events for debugging
        socket.onAny((eventName, ...args) => {
          addDebugLog(`Event: ${eventName}`, "info");
          console.log(`Socket event: ${eventName}`, args);
        });
      }

      function updateConnectionStatus(connected) {
        const statusEl = document.getElementById("connectionStatus");
        if (connected) {
          statusEl.className = "connection-status status-connected";
          statusEl.textContent = "‚úÖ Connected";
        } else {
          statusEl.className = "connection-status status-disconnected";
          statusEl.textContent = "‚ö†Ô∏è Disconnected";
        }
      }

      function addNotification(notification) {
        notification.read = false;
        notification.id = notification.id || "notif_" + Date.now();
        notifications.unshift(notification);
        updateNotificationsUI();
        updateStats();

        // Play sound
        playNotificationSound();
      }

      function updateNotificationsUI() {
        const container = document.getElementById("notificationsContainer");

        if (notifications.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Waiting for notifications...</p>
                        <p style="font-size: 14px;">Make a booking in Postman to see it appear here instantly!</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = notifications
          .map((notif) => {
            const time = notif.createdAt
              ? new Date(notif.createdAt).toLocaleTimeString()
              : new Date().toLocaleTimeString();
            return `
                    <div class="notification-item priority-${
                      notif.priority || "medium"
                    }">
                        <div class="notification-header">
                            <span class="notification-title">${
                              notif.icon || "üì¨"
                            } ${notif.title}</span>
                            <span class="notification-time">${time}</span>
                        </div>
                        <div class="notification-message">${notif.message}</div>
                        <span class="notification-type">${notif.type}</span>
                    </div>
                `;
          })
          .join("");
      }

      function updateStats() {
        document.getElementById("totalNotifications").textContent =
          notifications.length;
        const unread = notifications.filter((n) => !n.read).length;
        document.getElementById("unreadCount").textContent = unread;
      }

      function clearNotifications() {
        if (confirm("Clear all notifications?")) {
          notifications = [];
          updateNotificationsUI();
          updateStats();
          addDebugLog("Notifications cleared");
        }
      }

      function playNotificationSound() {
        try {
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.value = 800;
          oscillator.type = "sine";

          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + 0.3
          );

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.3);
        } catch (error) {
          console.log("Sound playback failed:", error);
        }
      }

      function logout() {
        if (confirm("Are you sure you want to logout?")) {
          localStorage.removeItem("token");
          localStorage.removeItem("userData");
          if (socket) {
            socket.disconnect();
          }
          location.reload();
        }
      }

      // Check if already logged in
      window.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        const savedUserData = localStorage.getItem("userData");

        if (token && savedUserData) {
          userData = JSON.parse(savedUserData);
          showDashboard();
          initializeSocket();
        }
      });
    </script>
  </body>
</html>
