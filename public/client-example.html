<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bus Booking - Real-time Updates</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      h1,
      h2 {
        color: #333;
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .connected {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .disconnected {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .notification {
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
        border-left: 4px solid #007bff;
        background: #e7f3ff;
        animation: slideIn 0.3s ease-out;
      }
      .notification.high {
        border-left-color: #dc3545;
        background: #ffe7e7;
      }
      .notification.medium {
        border-left-color: #ffc107;
        background: #fff8e7;
      }
      @keyframes slideIn {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      input,
      button {
        padding: 10px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .seats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .seat {
        padding: 10px;
        text-align: center;
        border-radius: 4px;
        font-weight: bold;
      }
      .seat.available {
        background: #d4edda;
        color: #155724;
      }
      .seat.booked {
        background: #f8d7da;
        color: #721c24;
      }
      .timestamp {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Bus Booking - Real-time Updates Demo</h1>

    <div class="container">
      <h2>Connection Status</h2>
      <div id="status" class="status disconnected">Disconnected</div>
    </div>

    <div class="container">
      <h2>Authentication</h2>
      <input
        type="text"
        id="token"
        placeholder="Enter JWT token"
        style="width: 400px"
      />
      <button onclick="connect()">Connect</button>
      <button onclick="disconnect()">Disconnect</button>
    </div>

    <div class="container">
      <h2>Watch Schedule</h2>
      <input type="number" id="scheduleId" placeholder="Schedule ID" min="1" />
      <input type="date" id="travelDate" />
      <button onclick="joinSchedule()">Join Schedule</button>
      <button onclick="leaveSchedule()">Leave Schedule</button>
      <button onclick="requestSeats()">Request Seat Info</button>
    </div>

    <div class="container">
      <h2>Available Seats</h2>
      <div id="seatInfo">
        <p>Join a schedule to see available seats</p>
      </div>
      <div id="seats" class="seats"></div>
    </div>

    <div class="container">
      <h2>Notifications</h2>
      <div id="notifications">
        <p>Waiting for notifications...</p>
      </div>
    </div>

    <script>
      let socket = null;
      let currentScheduleId = null;

      function connect() {
        const token = document.getElementById("token").value;

        socket = io("http://localhost:3000", {
          auth: {
            token: token,
          },
        });

        socket.on("connect", () => {
          updateStatus("Connected", true);
          addNotification("System", "Connected to server", "low");
        });

        socket.on("disconnect", () => {
          updateStatus("Disconnected", false);
          addNotification("System", "Disconnected from server", "medium");
        });

        socket.on("error", (error) => {
          addNotification("Error", error.message, "high");
        });

        // Booking events
        socket.on("booking:created", (data) => {
          addNotification("Booking Created", data.message, "high");
          console.log("Booking created:", data);
        });

        socket.on("booking:cancelled", (data) => {
          addNotification("Booking Cancelled", data.message, "medium");
          console.log("Booking cancelled:", data);
        });

        // Seat events
        socket.on("seats:updated", (data) => {
          addNotification("Seats Updated", data.message, "medium");
          if (data.scheduleId === currentScheduleId) {
            requestSeats();
          }
        });

        socket.on("seats:availability", (data) => {
          displaySeats(data);
          addNotification(
            "Seat Info",
            `${data.totalAvailable} seats available`,
            "low"
          );
        });

        socket.on("seats:low", (data) => {
          addNotification("⚠️ Limited Seats", data.message, "high");
        });

        // Schedule events
        socket.on("schedule:updated", (data) => {
          addNotification("Schedule Updated", data.message, "medium");
        });

        // Route events
        socket.on("route:updated", (data) => {
          addNotification("Route Updated", data.message, "medium");
        });

        // General notifications
        socket.on("notification", (data) => {
          addNotification(data.title, data.message, data.priority || "medium");
          console.log("Notification:", data);
        });

        // System notifications
        socket.on("system:notification", (data) => {
          addNotification(data.title, data.message, data.priority || "medium");
        });
      }

      function disconnect() {
        if (socket) {
          socket.disconnect();
          socket = null;
        }
      }

      function joinSchedule() {
        if (!socket) {
          alert("Please connect first");
          return;
        }

        const scheduleId = parseInt(
          document.getElementById("scheduleId").value
        );
        if (!scheduleId) {
          alert("Please enter a schedule ID");
          return;
        }

        currentScheduleId = scheduleId;
        socket.emit("join:schedule", scheduleId);
        addNotification("Room", `Joined schedule ${scheduleId}`, "low");

        // Request initial seat data
        setTimeout(() => requestSeats(), 500);
      }

      function leaveSchedule() {
        if (!socket || !currentScheduleId) return;

        socket.emit("leave:schedule", currentScheduleId);
        addNotification("Room", `Left schedule ${currentScheduleId}`, "low");
        currentScheduleId = null;

        document.getElementById("seatInfo").innerHTML = "<p>Left schedule</p>";
        document.getElementById("seats").innerHTML = "";
      }

      function requestSeats() {
        if (!socket || !currentScheduleId) return;

        const travelDate = document.getElementById("travelDate").value;
        if (!travelDate) {
          alert("Please select a travel date");
          return;
        }

        socket.emit("request:seats", {
          scheduleId: currentScheduleId,
          travelDate: travelDate,
        });
      }

      function displaySeats(data) {
        const seatInfo = document.getElementById("seatInfo");
        const seatsContainer = document.getElementById("seats");

        seatInfo.innerHTML = `
                <p><strong>Schedule ID:</strong> ${data.scheduleId}</p>
                <p><strong>Travel Date:</strong> ${data.travelDate}</p>
                <p><strong>Available Seats:</strong> ${data.totalAvailable}</p>
                <p class="timestamp">Updated: ${new Date(
                  data.timestamp
                ).toLocaleString()}</p>
            `;

        // Assume max 50 seats for display
        seatsContainer.innerHTML = "";
        for (let i = 1; i <= 50; i++) {
          const seatDiv = document.createElement("div");
          seatDiv.className = "seat";
          seatDiv.textContent = i;

          if (data.availableSeats.includes(i)) {
            seatDiv.classList.add("available");
          } else {
            seatDiv.classList.add("booked");
          }

          seatsContainer.appendChild(seatDiv);
        }
      }

      function updateStatus(message, connected) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className =
          "status " + (connected ? "connected" : "disconnected");
      }

      function addNotification(title, message, priority = "medium") {
        const container = document.getElementById("notifications");

        // Remove "waiting" message if present
        if (container.querySelector("p")) {
          container.innerHTML = "";
        }

        const notification = document.createElement("div");
        notification.className = `notification ${priority}`;
        notification.innerHTML = `
                <strong>${title}</strong><br>
                ${message}
                <div class="timestamp">${new Date().toLocaleString()}</div>
            `;

        container.insertBefore(notification, container.firstChild);

        // Keep only last 10 notifications
        while (container.children.length > 10) {
          container.removeChild(container.lastChild);
        }
      }

      // Set today's date as default
      document.getElementById("travelDate").valueAsDate = new Date();
    </script>
  </body>
</html>
